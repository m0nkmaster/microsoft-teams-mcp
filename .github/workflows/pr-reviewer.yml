name: PR Reviewer

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Prevent concurrent reviews on the same PR
concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  review:
    # Only run on PR events or comments on PRs (not issues)
    if: |
      github.event_name == 'pull_request' ||
      (github.event.issue.pull_request && !contains(github.event.comment.user.login, '[bot]'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        run: |
          git config user.name "Cursor Agent"
          git config user.email "agent@cursor.sh"

      - name: Get PR diff
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr-diff.txt
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV

      - name: Get PR info for comment
        if: github.event_name != 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          gh pr diff $PR_NUMBER > pr-diff.txt
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q '.title')
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "COMMENT_BODY<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.comment.body }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "COMMENT_USER=${{ github.event.comment.user.login }}" >> $GITHUB_ENV

      - name: Review PR
        if: github.event_name == 'pull_request'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          cursor-agent -p "You are a helpful code reviewer. Review this pull request and provide constructive feedback.

          PR Title: $PR_TITLE
          
          The diff is in pr-diff.txt. Read it and review the changes.
          
          Your task:
          1. Read the diff from pr-diff.txt
          2. Identify any bugs, security issues, performance problems, or code quality improvements
          3. Write your review as JSON to review-output.json
          
          OUTPUT FORMAT (review-output.json):
          {
            \"summary\": \"Brief overall assessment of the PR\",
            \"verdict\": \"approve\" | \"request_changes\" | \"comment\",
            \"comments\": [
              {
                \"path\": \"src/example.ts\",
                \"line\": 42,
                \"body\": \"Issue description here. For code suggestions use:\\n\\\`\\\`\\\`suggestion\\ncorrected code\\n\\\`\\\`\\\`\"
              }
            ]
          }
          
          RULES:
          - 'path' must match exactly a file path from the diff (e.g., 'src/api/chatsvc-api.ts')
          - 'line' must be a line number that exists in the NEW version of the file (right side of diff, lines with + or unchanged)
          - Use 'verdict': 'approve' if code is good, 'request_changes' for blocking issues, 'comment' for suggestions
          - comments array can be empty if no inline feedback needed
          - Be constructive and specific. Focus on meaningful improvements, not style nitpicks.
          
          IMPORTANT: Write valid JSON to review-output.json using the file write tool."

      - name: Post review with inline comments
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -s review-output.json ]; then
            echo "No review output generated"
            exit 1
          fi
          
          # Validate JSON
          if ! jq empty review-output.json 2>/dev/null; then
            echo "Invalid JSON in review-output.json, falling back to plain comment"
            gh pr comment $PR_NUMBER --body "$(cat review-output.json)

          <!-- pr-reviewer-bot -->"
            exit 0
          fi
          
          # Extract fields
          SUMMARY=$(jq -r '.summary // "No summary provided"' review-output.json)
          VERDICT=$(jq -r '.verdict // "comment"' review-output.json | tr '[:lower:]' '[:upper:]')
          
          # GitHub Actions cannot APPROVE or REQUEST_CHANGES on PRs by default
          # So we always use COMMENT event but show the verdict in the body
          EVENT="COMMENT"
          
          # Add verdict emoji to the summary
          case "$VERDICT" in
            APPROVE) VERDICT_PREFIX="âœ… **Verdict: Approve**" ;;
            REQUEST_CHANGES) VERDICT_PREFIX="ðŸ”´ **Verdict: Changes Requested**" ;;
            *) VERDICT_PREFIX="ðŸ’¬ **Verdict: Comment**" ;;
          esac
          
          # Build the review payload
          REVIEW_BODY="${VERDICT_PREFIX}

          ${SUMMARY}

          <!-- pr-reviewer-bot -->"
          
          # Check if there are inline comments
          COMMENT_COUNT=$(jq '.comments | length' review-output.json)
          
          if [ "$COMMENT_COUNT" -gt 0 ]; then
            # Build review with inline comments
            jq -n \
              --arg body "$REVIEW_BODY" \
              --arg event "$EVENT" \
              --slurpfile review review-output.json \
              '{
                body: $body,
                event: $event,
                comments: [$review[0].comments[] | {path: .path, line: .line, body: .body}]
              }' > review-payload.json
            
            echo "Posting review with $COMMENT_COUNT inline comment(s)..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --input review-payload.json
          else
            # No inline comments, just post the review summary
            echo "Posting review summary (no inline comments)..."
            jq -n \
              --arg body "$REVIEW_BODY" \
              --arg event "$EVENT" \
              '{body: $body, event: $event}' > review-payload.json
            
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --input review-payload.json
          fi
          
          echo "Review posted successfully"

      - name: Check if bot comment
        if: github.event_name != 'pull_request'
        id: check-bot
        run: |
          if echo "$COMMENT_BODY" | grep -q "<!-- pr-reviewer-bot -->"; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Respond to comment
        if: github.event_name != 'pull_request' && steps.check-bot.outputs.is_bot != 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          cursor-agent -p "You are an AI code reviewer assistant responding to a comment on a pull request.

          PR Title: $PR_TITLE
          Comment from @$COMMENT_USER:
          $COMMENT_BODY

          The PR diff is in pr-diff.txt if you need context.

          Provide a helpful, constructive response. You might:
          - Answer questions about your previous review
          - Clarify your suggestions  
          - Acknowledge if the commenter makes a good point
          - Provide additional context or alternatives

          If the comment doesn't require a response (e.g., just 'thanks' or 'done'), write 'NO_RESPONSE_NEEDED' to response-output.md and nothing else.
          
          Otherwise, write your complete response to response-output.md using the file write tool."

      - name: Post response comment
        if: github.event_name != 'pull_request' && steps.check-bot.outputs.is_bot != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s response-output.md ]; then
            # Check if agent decided no response is needed
            if grep -q "NO_RESPONSE_NEEDED" response-output.md; then
              echo "No response needed for this comment"
              exit 0
            fi
            # Append signature
            echo "" >> response-output.md
            echo "<!-- pr-reviewer-bot -->" >> response-output.md
            gh pr comment $PR_NUMBER --body-file response-output.md
          else
            echo "No response output generated"
          fi
